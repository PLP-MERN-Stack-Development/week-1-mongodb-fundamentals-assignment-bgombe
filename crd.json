// Task one: Create a MongoDB database named 'plp_bookstore' and a collection named 'books'.

use plp_bookstore
// task two: Create a collection named 'books' with the following fields: title, author, genre, published_year, price, in_stock, pages, publisher.
db.createCollection("books")

db.books.insertMany([
    {
    title: 'To Kill a Mockingbird',
    author: 'Harper Lee',
    genre: 'Fiction',
    published_year: 1960,
    price: 12.99,
    in_stock: true,
    pages: 336,
    publisher: 'J. B. Lippincott & Co.'
  },
  {
    title: '1984',
    author: 'George Orwell',
    genre: 'Dystopian',
    published_year: 1949,
    price: 10.99,
    in_stock: true,
    pages: 328,
    publisher: 'Secker & Warburg'
  },
  {
    title: 'The Great Gatsby',
    author: 'F. Scott Fitzgerald',
    genre: 'Fiction',
    published_year: 1925,
    price: 9.99,
    in_stock: true,
    pages: 180,
    publisher: 'Charles Scribner\'s Sons'
  },
  {
    title: 'Brave New World',
    author: 'Aldous Huxley',
    genre: 'Dystopian',
    published_year: 1932,
    price: 11.50,
    in_stock: false,
    pages: 311,
    publisher: 'Chatto & Windus'
  },
  {
    title: 'The Hobbit',
    author: 'J.R.R. Tolkien',
    genre: 'Fantasy',
    published_year: 1937,
    price: 14.99,
    in_stock: true,
    pages: 310,
    publisher: 'George Allen & Unwin'
  },
  {
    title: 'The Catcher in the Rye',
    author: 'J.D. Salinger',
    genre: 'Fiction',
    published_year: 1951,
    price: 8.99,
    in_stock: true,
    pages: 224,
    publisher: 'Little, Brown and Company'
  },
  {
    title: 'Pride and Prejudice',
    author: 'Jane Austen',
    genre: 'Romance',
    published_year: 1813,
    price: 7.99,
    in_stock: true,
    pages: 432,
    publisher: 'T. Egerton, Whitehall'
  },
  {
    title: 'The Lord of the Rings',
    author: 'J.R.R. Tolkien',
    genre: 'Fantasy',
    published_year: 1954,
    price: 19.99,
    in_stock: true,
    pages: 1178,
    publisher: 'Allen & Unwin'
  },
  {
    title: 'Animal Farm',
    author: 'George Orwell',
    genre: 'Political Satire',
    published_year: 1945,
    price: 8.50,
    in_stock: false,
    pages: 112,
    publisher: 'Secker & Warburg'
  },
  {
    title: 'The Alchemist',
    author: 'Paulo Coelho',
    genre: 'Fiction',
    published_year: 1988,
    price: 10.99,
    in_stock: true,
    pages: 197,
    publisher: 'HarperOne'
  },
  {
    title: 'Moby Dick',
    author: 'Herman Melville',
    genre: 'Adventure',
    published_year: 1851,
    price: 12.50,
    in_stock: false,
    pages: 635,
    publisher: 'Harper & Brothers'
  },
  {
    title: 'Wuthering Heights',
    author: 'Emily BrontÃ«',
    genre: 'Gothic Fiction',
    published_year: 1847,
    price: 9.99,
    in_stock: true,
    pages: 342,
    publisher: 'Thomas Cautley Newby'
  }

])
// aggregate:find all books from a specific genre
db.books.aggregate([
  { $group: { _id: "$title", total_books: { $sum: "$fantasy" } } }
])

// aggregate:find books published in the after a certain year

db.books.aggregate([
  {
    $group: {
      _id: "$title",
      total_books: {
        $sum: {
          $cond: [
            { $gte: ["$year", 1930] },
            1,
            0
          ]
        }
      }
    }
  }
])
// aggregate find books by a specific author
db.books.aggregate([
  {
    $lookup: {
      from: "books",
      localField: "author",
      foreignField: "author",
      as: "author_books"
    }
  },
  { $unwind: "$author_books" },
  { $match: { "author_books.author": "J.R.R. Tolkien" } },
  { 
    $group: { 
      _id: "$author_books.title", 
      total_books: { $sum: 1 },
      author: { $first: "$author_books.author" }
    } 
  },
  { 
    $project: { 
      _id: 0, 
      title: "$_id", 
      author: 1, 
      total_books: 1 
    } 
  }
])
// update the price of a specific book
db.books.updateOne(
  { title: "The Great Gutsby" },
  { $set: { price: 20.99 } }
)   

// delete a book by title
db.books.deleteOne(
  { title: "1984" }
)

// Task three:Advance queries

// find books that are both in stock & published after 2010
db.books.aggregate([
  {
    $match: {
      in_stock: true,
      published_year: { $gt: 2010 }
    }
  },
  {
    $project: {
      title: 1
    }
  }
])
// use projection to return only the title,author, and price 
db.books.aggregate([
    {$project:{
        title: 1,
        
    }}
])
// Implement  sorting  to display books by price in descending order
db.books.aggregate([
  {
    $sort: { price: -1 }
  },
  {
    $project: {
      title: 1,
      price: 1
    }
  }
])
// implement sorting the books by price in ascending order
db.books.aggregate([
    {
        $sort: { price: 1 }
    },
    {
        $project: {
            title: 1,
            price: 1
        }
    }
])
// use limit and skip to implement pagination
db.books.aggregate([
    { $sort: { published_year: -1 } },
    { $skip: 5 }, // Skip the first 5 documents
    { $limit: 10 }, // Limit to the next 10 documents
    {
        $project: {
            title: 1,
        }
    }
])    

// Task foru: create an aggregation pipeline to find the calculate the average price of books by genre
db.books.aggregate([
    {
        $group: {
            _id: "$genre",
            average_price: { $avg: "$price" }
        }
    },
    {
        $project: {
            _id: 0,
            genre: "$_id",
            average_price: 1
        }
    }
])


// create an aggregation pipeline to find the author with the most books in the collection
 db.books.aggregate([
    { 
        $group: {
            _id: "$author",
            total_books: { $sum: 1 }
        }
    },
    {
        $sort: { total_books: -1 } // Sort the total_books 
    },
    {
        $limit: 1 
    },
    {
        $project: {
            _id: 0,
            author: "$_id",
            total_books: 1
        }
    }
 ])
// implement a pipeline that groups books by publication decade and counts them
db.books.aggregate([
    {
        $group: {
            _id: { $floor: { $divide: ["$published_year", 10] } },
            total_books: { $sum: 1 }
        }
    },
    {
        $project: {
            decade: { $multiply: ["$_id", 10] },
            total_books: 1,
            _id: 0
        }
    },
    {
        $sort: { decade: 1 } // Sort by decade in ascending order
    }
])

// Task five: create an index on the title for faster searches
db.books.createIndex({ title: 1 })

// create a compound index on author and published_year
db.books.createIndex({ author: 1, published_year: 1 })

// use the explain() method to analyze the performance of a query
db.books.find({ title: "The Hobbit" }).explain("executionStats")